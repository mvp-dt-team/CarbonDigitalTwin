<!DOCTYPE html>
<html lang="ru">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Панель управления</title>
      <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
   </head>
   <body>
      <style>
         body {
         font-family: 'Montserrat', sans-serif;
         }
         .w-30 {
         width: 30%;
         }
      </style>
      <!--ШАПКА САЙТА-->
      <header class="py-3 mb-3 border-bottom">
         <div class="container-fluid d-grid gap-3 align-items-center" style="grid-template-columns: 1fr 2fr;">
            <div class="dropdown">
               <a href="#" class="d-flex align-items-center col-lg-4 mb-2 mb-lg-0 link-body-emphasis text-decoration-none dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                  <svg width="32px" height="32px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                     <path d="M4 6H20M4 12H20M4 18H20" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
               </a>
               <ul class="dropdown-menu text-small shadow">
                  <li><a class="dropdown-item" href="{% url 'block_list' %}">Раздел моделей</a></li>
                  <li><a class="dropdown-item" href="#">Раздел датчиков</a></li>
               </ul>
            </div>
            <div class="d-flex align-items-center">
               <form class="w-100 me-3" role="search">
                  <input type="search" class="form-control" placeholder="Search..." aria-label="Search">
               </form>
               <div class="flex-shrink-0 dropdown">
                  <a href="#" class="d-block link-body-emphasis text-decoration-none dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                     <svg width="32px" height="32px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M13.9794 2.97636C12.7523 2.27761 11.2477 2.27761 10.0207 2.97636L7.59467 4.35783L7.59463 4.35776L7.58436 4.36378L5.17499 5.77401C3.95632 6.48731 3.20403 7.79031 3.19563 9.20235L3.17903 11.994L3.17896 11.994L3.17903 12.0059L3.19563 14.7976C3.20403 16.2097 3.95632 17.5127 5.17499 18.226L7.58436 19.6362L7.58433 19.6363L7.59467 19.6422L10.0207 21.0236C11.2477 21.7224 12.7523 21.7224 13.9794 21.0236L16.4053 19.6422L16.4054 19.6422L16.4157 19.6362L18.825 18.226C20.0437 17.5127 20.796 16.2097 20.8044 14.7976L20.821 12.0059H20.8211L20.821 11.994L20.8044 9.20235C20.796 7.7903 20.0437 6.4873 18.825 5.77401L16.4157 4.36378L16.4157 4.36371L16.4053 4.35783L13.9794 2.97636ZM11.0103 4.71433C11.6239 4.36496 12.3762 4.36496 12.9897 4.71433L15.4105 6.09285L17.8147 7.50008C18.4241 7.85673 18.8002 8.50823 18.8044 9.21425L18.821 12L18.8044 14.7857C18.8002 15.4918 18.4241 16.1433 17.8147 16.4999L15.4105 17.9072L12.9897 19.2857C12.3762 19.635 11.6239 19.635 11.0103 19.2857L8.58952 17.9071L6.18528 16.4999C5.57594 16.1433 5.1998 15.4918 5.1956 14.7857L5.17903 12L5.1956 9.21425C5.1998 8.50823 5.57594 7.85673 6.18528 7.50008L8.5895 6.09286L11.0103 4.71433ZM11 12C11 11.4477 11.4477 11 12 11C12.5523 11 13 11.4477 13 12C13 12.5523 12.5523 13 12 13C11.4477 13 11 12.5523 11 12ZM12 9C10.3432 9 9.00001 10.3431 9.00001 12C9.00001 13.6568 10.3432 15 12 15C13.6569 15 15 13.6568 15 12C15 10.3431 13.6569 9 12 9Z" fill="#000000"/>
                     </svg>
                  </a>
                  <ul class="dropdown-menu text-small shadow">
                     <li><a class="dropdown-item" href="#">Выход</a></li>
                  </ul>
               </div>
            </div>
         </div>
      </header>
      <!---->
      <div class="container">
         <main class="row">
            <div class="col-md-7 mb-4">
               <div class="p-4 rounded" style="background-color: #EEEEEE;">
                  <h1 class="h4">{{block.name}} <span class="badge text-bg-secondary">ID {{block.id}}</span></h1>
                  <p>Предсказание свойств</p>
                  <div class="d-flex justify-content-between mt-4">
                     <div class="bg-white p-3 rounded text-center w-30">
                        <span>Статус</span><br>
                        {%if block.active%}
                        <span class="text-success font-weight-bold">В работе</span>
                        {% else %}
                        <span class="text-danger font-weight-bold">Отключен</span>
                        {% endif %}
                     </div>
                     <div class="bg-white p-3 rounded text-center w-30">
                        <span>Текущее значение</span><br>
                        <span class="h5" id="current_prediction">--</span>
                     </div>
                     <div class="bg-white p-3 rounded text-center w-30">
                        <span>Частота опроса</span><br>
                        <span>Раз в 5 сек</span>
                     </div>
                  </div>
                  <div class="rounded justify-content-between mt-4">
                     <h4 class="text-dark">Настройки</h4>
                     <button class="btn btn-secondary btn-block mb-2">Дообучить модель</button>
                     <button class="btn btn-secondary btn-block mb-2">Сменить модель</button>
                     <button class="btn btn-secondary btn-block mb-2">Параметры модуля</button>
                  </div>
               </div>
            </div>
            <div class="col-md-5">
               <div class="p-4 rounded mb-4" style="background-color: #EEEEEE;">
                  <h2 class="h5">Список подключенных датчиков</h2>
                  <ol class="list-group list-group-numbered">
                     {% for sensor in sensors %}
                     <li class="list-group-item d-flex justify-content-between align-items-start">
                        <div class="ms-2 me-auto">
                           <div class="fw-bold">{{sensor.name}} <span class="badge text-bg-secondary">ID {{sensor.sensor_model_id}}-{{sensor.id}}-{{sensor.measurement_source_id}}</span></div>
                           {{sensor.description}} <br>
                           {{sensor.unit}}
                        </div>
                     </li>
                     {% endfor %}
                  </ol>
               </div>
               <div class="p-4 rounded" style="background-color: #EEEEEE;">
                  <h2 class="h5">Измеряемые свойства</h2>
                  <ol class="list-group list-group-numbered">
                     {% for property in block.properties %}
                     <li class="list-group-item d-flex justify-content-between align-items-start">
                        <div class="ms-2 me-auto">
                           <div class="fw-bold">{{property.name}} </div>
                           {{property.unit}}
                        </div>
                     </li>
                     {% endfor %}
                  </ol>
               </div>
            </div>
         </main>
         <footer class="d-flex justify-content-between align-items-center mt-4">
            <div>
               {%if block.active%}
               <a href="{% url 'toggle_block' block.id %}" class="btn btn-danger mr-2">Выключить</a>
               {% else %}
               <a href="{% url 'toggle_block' block.id %}" class="btn btn-success mr-2">Включить</a>
               {% endif %}
            </div>
         </footer>
         <div style="width: 75%; margin: auto;">
            <canvas id="myChart"></canvas>
         </div>
      </div>
      </div>
      <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
      <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
      <script>
         // script.js
         
         // Функция для отправки запроса к API
         function fetchDataAndUpdateElement() {
         // Здесь задаем URL вашего API
         const apiUrl = '{% url "get_predictions" block.id 1 %}';
         
         // Отправляем GET запрос с помощью fetch
         fetch(apiUrl)
         .then(response => response.json())
         .then(data => {
             // Полученные данные (предполагается, что API возвращает JSON с числом)
             const number = data[0].m_data; // Предположим, что число находится в свойстве 'number'
         
             // Находим элемент на странице, куда будем вставлять число
             const numberElement = document.getElementById('current_prediction');
         
             // Проверяем, если число определено и не пустое
             if (number !== undefined && number !== null) {
                 numberElement.textContent = number;
             } else {
                 numberElement.textContent = '--'; // Если число не определено или пустое
             }
         })
         .catch(error => {
             console.error('Ошибка при выполнении запроса:', error);
             // В случае ошибки можно выполнить дополнительные действия, например, вывести сообщение об ошибке на странице
         });
         }
         
         // Запускаем функцию fetchDataAndUpdateElement каждую секунду
         setInterval(fetchDataAndUpdateElement, 1000);
      </script>
      <script>
         // Создание контекста для графика
         const ctx = document.getElementById('myChart').getContext('2d');
         
         // Инициализация графика
         const myChart = new Chart(ctx, {
         type: 'line',
         data: {
         labels: [], // Метки для оси X
         datasets: [{
             label: 'Data Trend',
             data: [], // Данные для оси Y
             borderColor: 'rgba(75, 192, 192, 1)',
             borderWidth: 1,
             fill: false
         }]
         },
         options: {
         scales: {
             x: {
                 type: 'time',
                 time: {
                     unit: 'second'
                 },
                 title: {
                     display: true,
                     text: 'Timestamp'
                 }
             },
             y: {
                 title: {
                     display: true,
                     text: 'Data'
                 }
             }
         }
         }
         });
         
         // Функция для получения данных из API
         async function fetchData() {
         try {
         const response = await fetch('{% url "get_predictions" block.id 10 %}');
         const data = await response.json();
         
         // Обновление данных на графике
         updateChart(data);
         } catch (error) {
         console.error('Error fetching data:', error);
         }
         }
         
         // Функция для обновления данных на графике
         function updateChart(data) {
         const labels = data.map(item => new Date(item.insert_ts * 1000)); // Преобразуем timestamp в объект Date
         const values = data.map(item => item.m_data);
         
         myChart.data.labels = labels;
         myChart.data.datasets[0].data = values;
         myChart.update();
         }
         
         // Обновление данных каждые 1 секунду
         setInterval(fetchData, 1000);
         
         // Инициализация первого вызова
         fetchData();
         
      </script>
      
   </body>
</html>